#include<Encoder.h>

Encoder myEnc(2, 3);// Encoder Pins
const int switchPin = 7; // Momentary switch pin
const int relayPin = 6;// Relay Pin
// Variables
const int encoderThreshold = 30; //Encoder Threshold 
long oldPosition  = 0;
long newPosition = 0;
unsigned long lastChangeTime = 0;
const unsigned long changeInterval = 2000; // Waittime After Detachment of Payload

void setup() {

  pinMode(switchPin, INPUT_PULLUP); // Enable internal pull-up resistor for switch pin
  pinMode(relayPin, OUTPUT);
  Serial.begin(9600); // Initialize serial communication

}

void loop() {
  // Encoder Count Reader
  long newPosition = myEnc.read();
  if (newPosition != oldPosition) {
    oldPosition = newPosition;
    lastChangeTime = millis(); 
  }
  if (digitalRead(switchPin) == LOW){
    Serial.println("Switch Pressed");
    turnoffrelay();
    newPosition = 0;
  }
  if (newPosition > encoderThreshold && millis() - lastChangeTime >= changeInterval) { // If encoder count remains unchanged for 3 seconds
      // Rotate motor clockwise until switch is pressed
      Serial.println("Rotating motor clockwise...");
      rotatemotorclockwise();
  }
  if (true){
    // Print encoder count for debugging
  Serial.print("Encoder count: ");
  Serial.println(newPosition);
  delay(1000); // Delay for readability
  }
}


void turnoffrelay() {
  digitalWrite(relayPin, HIGH);
}

void rotatemotorclockwise(){
  digitalWrite(relayPin, LOW);
}

